# =============================================================================
# Docker Compose with Caddy Reverse Proxy
# =============================================================================
# Use this file for deployments that include the Caddy reverse proxy.
# In Portainer, set the Compose path to: docker-compose.caddy.yml
#
# Required environment variables:
#   - SONARR_API_KEY: Your Sonarr API key
#   - MCP_DOMAIN: Your domain name (e.g., mcp-sonarr.example.com)
#   - ACME_EMAIL: Email for Let's Encrypt notifications
#   - X_MCP_TOKEN: Secret token for ChatGPT MCP client authentication
# =============================================================================

services:
  mcp-sonarr:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-sonarr
    restart: unless-stopped
    # No external ports - Caddy handles all external traffic
    expose:
      - "8080"
    environment:
      # Required: Your Sonarr instance URL
      - SONARR_URL=${SONARR_URL:-https://sonarr.zenmedia.live}
      # Required: Your Sonarr API key (get from Sonarr -> Settings -> General -> API Key)
      - SONARR_API_KEY=${SONARR_API_KEY}
      # Optional: Simple authentication token for the MCP server
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-}
      # Optional: Server configuration
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8080
      # OAuth 2.0 Configuration (for ChatGPT integration)
      - OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID:-}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET:-}
      - OAUTH_AUTH_PASSWORD=${OAUTH_AUTH_PASSWORD:-}
      - OAUTH_JWT_SECRET=${OAUTH_JWT_SECRET:-}
      - OAUTH_ACCESS_TOKEN_EXPIRE_MINUTES=${OAUTH_ACCESS_TOKEN_EXPIRE_MINUTES:-60}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - mcp-network

  caddy:
    image: caddy:2-alpine
    container_name: mcp-caddy
    restart: unless-stopped
    ports:
      # HTTP port - used for ACME challenges and HTTP->HTTPS redirect
      - "80:80"
      # HTTPS port - main secure traffic
      - "443:443"
      # HTTPS/3 (QUIC) - optional, for HTTP/3 support
      - "443:443/udp"
    environment:
      # Domain for the MCP server (used in Caddyfile)
      - MCP_DOMAIN=${MCP_DOMAIN:-mcp-sonarr.localhost}
      # Email for Let's Encrypt certificate notifications
      - ACME_EMAIL=${ACME_EMAIL:-admin@example.com}
      # Secret token for ChatGPT MCP client authentication
      # ChatGPT must send this in the X-MCP-Token header
      - X_MCP_TOKEN=${X_MCP_TOKEN}
    volumes:
      # Caddyfile configuration
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      # Persistent storage for certificates and Caddy data
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      mcp-sonarr:
        condition: service_healthy
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mcp-network:
    driver: bridge

volumes:
  # Caddy data volume - stores certificates, OCSP staples, etc.
  caddy_data:
  # Caddy config volume - stores auto-generated config
  caddy_config:
